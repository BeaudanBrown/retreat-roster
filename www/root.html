{{ define "root" }}
{{ $staff := .Staff }}
{{ $isLive := .IsLive }}
{{ $activeStaff := .ActiveStaff }}
{{ $config := $activeStaff.Config }}
{{ $startDate := WeekStartFromOffset $config.RosterDateOffset }}
{{ $server := .Server }}
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
	<head>
		<base href="/">
		<title>Retreat Roster</title>
		<link rel="stylesheet" href="app.css?v={{ .CacheBust }}">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
		<script src="https://unpkg.com/htmx.org@1.9.10"></script>
		<script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
		<script src="https://unpkg.com/html2canvas"></script>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
	</head>
	<script>
	function formatDate(dateStr) {
		const date = new Date(dateStr);
		let day = date.getDate().toString().padStart(2, '0');
		let month = (date.getMonth() + 1).toString().padStart(2, '0');
		let year = date.getFullYear().toString().slice(-2);
		return `${day}_${month}_${year}`;
	}

	function saveImage() {
		let dateStr = formatDate({{ $startDate }});

		const style = document.createElement('style');
		document.head.appendChild(style);
		style.sheet?.insertRule('body > div:last-child img { display: inline-block; }');

		html2canvas(document.querySelector("#roster-jpg")).then(canvas => {
			style.remove();
			let a = document.createElement('a');
			a.href = canvas.toDataURL("image/jpeg").replace("image/jpeg", "image/octet-stream");
			a.download = `roster_${dateStr}.jpg`;
			a.click();
		});
	}
	</script>
	<body id="roster" class="w-full p-0 m-0 flex flex-col items-center justify-center bg-gray-900">
	<script>
		if (typeof initFlowbite !== 'undefined') {
			initFlowbite();
			console.log('Flowbite has been initialized.');
		} else {
			console.error('initFlowbite is not available.');
		}

		// Preserve scroll position across HTMX swaps
		let savedScrollPosition = 0;
		
		document.body.addEventListener('htmx:beforeSwap', function(evt) {
			// Save current scroll position before swap
			savedScrollPosition = window.scrollY || document.documentElement.scrollTop;
		});
		
		document.body.addEventListener('htmx:afterSwap', function(evt) {
			// Restore scroll position after swap completes
			window.scrollTo(0, savedScrollPosition);
			
			// Re-initialize Flowbite after content swap
			if (typeof initFlowbite !== 'undefined') {
				initFlowbite();
			}
		});
	</script>
		{{ template "header" (MakeHeaderStruct .ActiveStaff.IsManagerRole .IsLive) }}
		{{ template "rosterMainContainer" . }}
		<div id="staff-profile-modal-container"></div>
	</body>
</html>
{{ end }}
