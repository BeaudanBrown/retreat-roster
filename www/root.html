{{ define "root" }}
<div id="roster" class="roster-container">
  {{ $staff := .Staff }}
  {{ $startDate := .StartDate }}
  {{ $isLive := .IsLive }}
  {{ $activeStaff := .ActiveStaff }}
  {{ if not .ActiveStaff.IsAdmin }}
    <div id="roster-jpg">
    {{ range .Days }}
      {{ $dayStruct := MakeDayStruct . $staff $startDate $isLive $activeStaff }}
      {{if $isLive }}
        {{ template "rosterDayLocked" $dayStruct }}
      {{ end }}
    {{ end }}
    </div>
  {{ else }}
  <div>
    <label>
      <input type="checkbox" {{ if .IsLive }}checked{{ end }}
        hx-get="/toggleLive"
        hx-target="#roster"
        hx-trigger="change"
        hx-swap='outerHTML'>
        Make Public
    </label>
  </div>
  <div>
    {{if not $isLive }}
      <button hx-post='/shiftWindow' hx-ext='json-enc' hx-vals='js:{"action":"-"}' hx-swap='outerHTML' hx-target='#roster'>-</button>
      <button hx-post='/shiftWindow' hx-ext='json-enc' hx-vals='js:{"action":"0"}' hx-swap='outerHTML' hx-target='#roster'>This week</button>
      <button hx-post='/shiftWindow' hx-ext='json-enc' hx-vals='js:{"action":"+"}' hx-swap='outerHTML' hx-target='#roster'>+</button>
    {{ end }}
  </div>
  <div id="roster-jpg">
  {{ range .Days }}
    {{ $dayStruct := MakeDayStruct . $staff $startDate $isLive $activeStaff }}
    {{if $isLive }}
      {{ template "rosterDayLocked" $dayStruct }}
    {{ else }}
      {{ template "rosterDay" $dayStruct }}
    {{ end }}
  {{ end }}
  </div>
  {{if not $isLive }}
    <div class="form-container">
      <form id="addTrialForm" hx-post="/addTrial" hx-ext="json-enc" hx-swap="outerHTML" hx-target="#roster">
        <label>Add New Trial</label>
        <div class="form-container">
          <input type="text" name="name" id="customStaff" value="Trial" onfocus="this.select();" onclick="this.select();" />
          <button type="submit">+</button>
        </div>
      </form>
    </div>
    {{ range .Staff }}
      {{if .IsTrial }}
        <div>{{ .FirstName }} <a href="#" hx-ext="json-enc" hx-post="/deleteAcc" hx-vals='js:{"id":"{{ .ID }}"}' hx-swap="outerHTML" hx-target="#roster">ðŸ—‘</a></div>
      {{end}}
    {{ end }}
    <button id="capture" style="display:none;">Capture as JPG</button>
    <h2>All Staff</h2>
    <div class="staff-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone #</th>
            <th>Ideal # of Shifts</th>
            <th>Hidden</th>
            <th>Admin</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          {{ range .Staff }}
            {{if not .IsTrial }}
              <tr class="staff-row">
                <td>{{ .FirstName }} {{ .LastName }}</td>
                <td>{{ .Email }}</td>
                <td>{{ .Phone }}</td>
                <td>{{ .IdealShifts }}</td>
                <td>
                  <input type="checkbox" {{ if .IsHidden }}checked{{ end }}
                    hx-ext="json-enc"
                    hx-post="/toggleHidden"
                    hx-target="#roster"
                    hx-trigger="change"
                    hx-vals='{"id": "{{ .ID }}"}'
                    hx-swap='outerHTML'>
                </td>
                <td>
                  <input type="checkbox" {{ if .IsAdmin }}checked{{ end }}
                    hx-ext="json-enc"
                    hx-post="/toggleAdmin"
                    hx-target="#roster"
                    hx-trigger="change"
                    hx-vals='{"id": "{{ .ID }}"}'
                    hx-swap='outerHTML'>
                </td>
                <td>
                  {{if not .IsAdmin }}
                  <a href="#" hx-ext="json-enc" hx-confirm="Are you sure you want to delete this staff member?" hx-post="/deleteAcc" hx-vals='js:{"id":"{{ .ID }}"}' hx-swap="outerHTML" hx-target="#roster">ðŸ—‘</a>
                  {{end}}
                </td>
              </tr>
            {{end}}
          {{ end }}
        </tbody>
      </table>
    </div>

    <h2>Leave Requests</h2>
    {{ range $staff }}
      {{ $name := .FirstName }}
      {{ range .LeaveRequests }}
        <div class="leave-request-row">
          <div class="leave-reason">Staff: {{ $name }}</div>
          <div class="leave-reason">Reason: {{ .Reason }}</div>
          <div class="leave-start-date">Unavailable from: {{ .StartDate.Format "Jan 2, 2006" }}</div>
          <div class="leave-end-date">Available again: {{ .EndDate.Format "Jan 2, 2006" }}</div>
          <a href="#" hx-ext="json-enc" class="delete-icon" hx-post="/deleteAdminLeaveReq" hx-vals='js:{"id":"{{ .ID }}"}' hx-swap="outerHTML" hx-target="#roster">ðŸ—‘</a>
        </div>
      {{ end }}
    {{ end }}

  {{ else }}
    <button id="capture">Save image</button>
  {{ end }}
  {{ end }}
  <a href="#" hx-post="/auth/logout">Logout</a>
  <a href="/profile">Edit Profile</a>
</div>

<script>
function formatDate(dateStr) {
  const date = new Date(dateStr);
  let day = date.getDate().toString().padStart(2, '0');
  let month = (date.getMonth() + 1).toString().padStart(2, '0'); // January is 0!
  let year = date.getFullYear().toString().slice(-2); // Get last two digits of the year
  return `${day}_${month}_${year}`;
}

if (!!document.getElementById("capture")) {
  document.getElementById("capture").addEventListener("click", function() {
    let dateStr = formatDate({{ $startDate }});
    html2canvas(document.querySelector("#roster-jpg")).then(canvas => {
      let a = document.createElement('a');
      a.href = canvas.toDataURL("image/jpeg").replace("image/jpeg", "image/octet-stream");
      a.download = `roster_${dateStr}.jpg`; // File name incorporates formatted start date
      a.click();
    });
  });
}

</script>
{{ end }}
