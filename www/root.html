{{ define "root" }}
<div id="roster" class="roster-container">
  {{ $staff := .Staff }}
  {{ $startDate := .StartDate }}
  {{ $isLive := .IsLive }}
  {{ $activeStaff := .ActiveStaff }}
  {{ $server := .Server }}
  {{ template "header" (MakeHeaderStruct .ActiveStaff.IsAdmin .IsLive) }}
  {{ if not .ActiveStaff.IsAdmin }}
    <div id="roster-jpg">
    {{ range .Days }}
      {{ $dayStruct := MakeDayStruct . $server $activeStaff }}
      {{if $isLive }}
        {{ template "rosterDayLocked" $dayStruct }}
      {{ end }}
    {{ end }}
    </div>
  {{ else }}
  <div>
    <label>
      <input type="checkbox" {{ if .IsLive }}checked{{ end }}
        hx-get="/toggleLive"
        hx-target="#roster"
        hx-trigger="change"
        hx-swap='outerHTML'>
        Make Public
    </label>
  </div>
  {{if not $isLive }}
    <div>
      <button hx-post='/shiftWindow' hx-ext='json-enc' hx-vals='js:{"action":"-"}' hx-swap='outerHTML' hx-target='#roster'>-</button>
      <button hx-post='/shiftWindow' hx-ext='json-enc' hx-vals='js:{"action":"0"}' hx-swap='outerHTML' hx-target='#roster'>This week</button>
      <button hx-post='/shiftWindow' hx-ext='json-enc' hx-vals='js:{"action":"+"}' hx-swap='outerHTML' hx-target='#roster'>+</button>
    </div>
    <div>
      <label>Hide staff with:</label>
    </div>
    <div class="buttons" id="filters">
      <label>
        <input type="checkbox" {{ if .HideByIdeal }}checked{{ end }}
          hx-get="/toggleHideByIdeal"
          hx-target="#roster"
          hx-trigger="change"
          hx-swap='outerHTML'>
          Ideal # shifts
      </label>
      <label>
        <input type="checkbox" {{ if .HideByPrefs }}checked{{ end }}
          hx-get="/toggleHideByPreferences"
          hx-target="#roster"
          hx-trigger="change"
          hx-swap='outerHTML'>
          Preference conflict
      </label>
      <label>
        <input type="checkbox" {{ if .HideByLeave }}checked{{ end }}
          hx-get="/toggleHideByLeave"
          hx-target="#roster"
          hx-trigger="change"
          hx-swap='outerHTML'>
          Leave requests
      </label>
    </div>
  {{ end }}
  <div id="roster-jpg">
  {{ range .Days }}
    {{ $dayStruct := MakeDayStruct . $server $activeStaff }}
    {{if $isLive }}
      {{ template "rosterDayLocked" $dayStruct }}
    {{ else }}
      {{ template "rosterDay" $dayStruct }}
    {{ end }}
  {{ end }}
  </div>
  {{if not $isLive }}
    <div class="form-container">
      <form id="addTrialForm" hx-post="/addTrial" hx-ext="json-enc" hx-swap="outerHTML" hx-target="#roster">
        <label>Add New Trial</label>
        <div class="form-container">
          <input type="text" name="name" id="customStaff" value="Trial" onfocus="this.select();" onclick="this.select();" />
          <button type="submit">+</button>
        </div>
      </form>
    </div>
    {{ range .Staff }}
      {{if .IsTrial }}
        <div>{{ .FirstName }} <a href="#" hx-ext="json-enc" hx-post="/deleteAcc" hx-vals='js:{"id":"{{ .ID }}"}' hx-swap="outerHTML" hx-target="#roster">üóë</a></div>
      {{end}}
    {{ end }}
    <button id="capture" style="display:none;">Capture as JPG</button>

  {{ else }}
    <button id="capture">Save image</button>
  {{ end }}
    <h2>Leave Requests</h2>
    <table>
      <thead>
        <tr>
          <th>Staff</th>
          <th>Created</th>
          <th>Reason</th>
          <th>Unavailable from</th>
          <th>Available again</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        {{ range $staff }}
          {{ $name := .FirstName }}
          {{if not (eq .NickName "")}}
            {{ $name = .NickName }}
          {{end}}
          {{ range .LeaveRequests }}
            <tr>
              <td>{{ $name }}</td>
              <td>{{ .CreationDate.Format "02/01/06" }}</td>
              <td>{{ .Reason }}</td>
              <td>{{ .StartDate.Format "02/01/06" }}</td>
              <td>{{ .EndDate.Format "02/01/06" }}</td>
              <td>
                <a href="#" hx-ext="json-enc" class="delete-icon" hx-post="/deleteLeaveReq" hx-vals='js:{"id":"{{ .ID }}"}' hx-swap="outerHTML" hx-target="#roster">üóëÔ∏è</a>
              </td>
            </tr>
          {{ end }}
        {{ end }}
      </tbody>
    </table>
    <h2>All Staff</h2>
    <div class="staff-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone #</th>
            <th>Contact Name</th>
            <th>Contact Phone #</th>
            <th>Current Shifts</th>
            <th>Ideal Shifts</th>
            <th>Hidden</th>
            <th>Admin</th>
            <th>Edit</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          {{ range .Staff }}
            {{if not .IsTrial }}
              <tr class="staff-row">
                {{if not (eq .NickName "") }}
                  <td>{{ .NickName }}</td>
                {{else}}
                  <td>{{ .FirstName }}</td>
                {{end}}
                <td>{{ .Email }}</td>
                <td>{{ .Phone }}</td>
                <td>{{ .ContactName }}</td>
                <td>{{ .ContactPhone }}</td>
                <td>{{ .CurrentShifts }}</td>
                <td>{{ .IdealShifts }}</td>
                <td>
                  <input type="checkbox" {{ if .IsHidden }}checked{{ end }}
                    hx-ext="json-enc"
                    hx-post="/toggleHidden"
                    hx-target="#roster"
                    hx-trigger="change"
                    hx-vals='{"id": "{{ .ID }}"}'
                    hx-swap='outerHTML'>
                </td>
                <td>
                  <input type="checkbox" {{ if .IsAdmin }}checked{{ end }}
                    hx-ext="json-enc"
                    hx-post="/toggleAdmin"
                    hx-target="#roster"
                    hx-trigger="change"
                    hx-vals='{"id": "{{ .ID }}"}'
                    hx-swap='outerHTML'>
                </td>
                <td>
                  <a href="/profile?editStaffId={{ .ID }}">‚úèÔ∏è</a>
                </td>
                <td>
                  <a href="#" hx-ext="json-enc" hx-confirm="Are you sure you want to delete this staff member?" hx-post="/deleteAcc" hx-vals='js:{"id":"{{ .ID }}"}' hx-swap="outerHTML" hx-target="#roster">üóëÔ∏è</a>
                </td>
              </tr>
            {{end}}
          {{ end }}
        </tbody>
      </table>
    </div>
  {{ end }}
</div>

<script>
function formatDate(dateStr) {
  const date = new Date(dateStr);
  let day = date.getDate().toString().padStart(2, '0');
  let month = (date.getMonth() + 1).toString().padStart(2, '0'); // January is 0!
  let year = date.getFullYear().toString().slice(-2); // Get last two digits of the year
  return `${day}_${month}_${year}`;
}

if (!!document.getElementById("capture")) {
  document.getElementById("capture").addEventListener("click", function() {
    let dateStr = formatDate({{ $startDate }});
    html2canvas(document.querySelector("#roster-jpg")).then(canvas => {
      let a = document.createElement('a');
      a.href = canvas.toDataURL("image/jpeg").replace("image/jpeg", "image/octet-stream");
      a.download = `roster_${dateStr}.jpg`; // File name incorporates formatted start date
      a.click();
    });
  });
}

</script>
{{ end }}
